# ==============================================================================
# Taken from:
# https://github.com/pablospe/cmake-example-library/blob/master/cmake/Uninstall.cmake.in
# which, in turn, is based on:
# http://www.cmake.org/Wiki/CMake_FAQ#Can_I_do_.22make_uninstall.22_with_CMake.3F
# ==============================================================================
# Define the function 'delete_folder_if_empty'
function(delete_folder_if_empty DIR)
  if(NOT EXISTS ${DIR})
    return()
  endif()

  # Check if folder is empty
  file(GLOB_RECURSE RESULT "${DIR}/*")
  if(NOT RESULT)
    message(STATUS "Deleted empty folder ${DIR}")
    file(REMOVE_RECURSE ${DIR})
  endif()
endfunction(delete_folder_if_empty)

# Find 'install_manifest.txt' which contains a list of the installed files
if(NOT EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/install_manifest.txt")
  message(
    FATAL_ERROR
      "Cannot find install manifest: ${CMAKE_CURRENT_SOURCE_DIR}/install_manifest.txt"
  )
endif()

# Remove files from 'install_manifest.txt'
message(STATUS "")
message(STATUS "Removing files from 'install_manifest.txt'")
file(READ "${CMAKE_CURRENT_SOURCE_DIR}/install_manifest.txt" INSTALLED_FILES)
string(REGEX REPLACE "\n" ";" INSTALLED_FILES "${INSTALLED_FILES}")
foreach(FILE IN LISTS INSTALLED_FILES)
  message(STATUS "Uninstalling $ENV{DESTDIR}${FILE}")
  if(IS_SYMLINK "$ENV{DESTDIR}${FILE}" OR EXISTS "$ENV{DESTDIR}${FILE}")
    file(REMOVE "$ENV{DESTDIR}${FILE}")
    if(EXISTS "$ENV{DESTDIR}${FILE}")
      message(FATAL_ERROR "Problem when removing $ENV{DESTDIR}${FILE}")
    endif()
  else()
    message(STATUS "File $ENV{DESTDIR}${FILE} does not exist.")
  endif()

  # Store parent folders to possibly delete (will only delete it if empty)
  if(NOT (FILE MATCHES ".+.pc"))
    cmake_path(GET FILE PARENT_PATH PARENT_DIR)
    set(ALL_PARENT_DIRS ${ALL_PARENT_DIRS} ${PARENT_DIR})
  endif()
endforeach()

# The list of auto-generated combined headers
set(OOMPHLIB_COMBINED_HEADERS "@OOMPHLIB_COMBINED_HEADERS@")

# Remove auto-generated combined headers
message(STATUS "")
message(STATUS "Removing installed (auto-generated) combined headers")
foreach(HEADER IN LISTS OOMPHLIB_COMBINED_HEADERS)
  message(STATUS "Removing ${HEADER}")
  if(IS_SYMLINK "${HEADER}" OR EXISTS "${HEADER}")
    file(REMOVE ${HEADER})
    if(EXISTS ${HEADER})
      message(FATAL_ERROR "Problem when removing ${HEADER}")
    endif()
  else()
    message(STATUS "File ${HEADER} does not exist.")
  endif()

  # Update parent folders to possibly delete (will only delete it if empty)
  cmake_path(GET HEADER PARENT_PATH PARENT_DIR)
  list(APPEND ALL_PARENT_DIRS ${PARENT_DIR})
endforeach()

# Remove empty folders
message(STATUS "")
message(STATUS "Removing empty folders")

list(REMOVE_DUPLICATES ALL_PARENT_DIRS)
foreach(PARENT_DIR IN LISTS ALL_PARENT_DIRS)
  delete_folder_if_empty(${PARENT_DIR})
endforeach()

delete_folder_if_empty("/usr/local/lib/oomphlib")
delete_folder_if_empty("/usr/local/lib/cmake/oomphlib")
delete_folder_if_empty("/usr/local/include/oomphlib")
delete_folder_if_empty("/usr/local/bin/oomphlib")

message(STATUS "Uninstall complete.")
# ------------------------------------------------------------------------------
